---
title: "Mass Shootings in the USA"
author: "Hannah Reitz & Sophie Hensgen"
date: "5/14/2020"
output: html_document
---
Hallo Hannah
```{r}
library(openxlsx)
library(xml2)
library(rvest)
library(jsonlite)
library(robotstxt)
library(RSocrata)
library(dplyr)
library(rlist)
library(pipeR)
library(gtrendsR)
library(lubridate)
library(writexl)
library(readxl)

```
## Theory and Hypotheses


Test Git

weiterer test



More dead people --> more media attention --> higher attention in Google trends

newworthiness in den Medien

1. The more people got injured, the longer the shooting stayed in the trends.

2. The more deaths, the longer the shooting stayed in the trends.

evtl. newswothiness in Kombination mit inequality

3. If the shooter is black, the shooting stayed longer
in the trends.

4. Shootings in richer areas, stayed longer in the trends.


5. In states with looser gun control, shootings stayed longer in the trends


## Data from Wikipedia

Erlärung welche Daten, wie gescrapt, wie sehen die Daten aus Deskription


```{r}
url <- "https://en.wikipedia.org/wiki/List_of_mass_shootings_in_the_United_States"
t <- read_html(url)
table <- t %>% html_nodes("#mw-content-text > div > table") %>% html_table(trim=T)

table

```

hier Tabellen zusammensetzten

erstes klappt, danach gibt es ein problem mit incompatiblen types. 
Ich glaube wir müssen die buchstaben aus injured rausholen damit wir es in einen integer umändern können

To Do:

- gsub loop --> alle alle nicht zahlen rausziehen
- alle mutaten damit alle integer sein 
- wenn das gemacht alle joinen zu einer großen tabelle
- in excel Extra Variablen hinzufügen
- Datum in Zahlen ändern
- zwei neue variablen, eine zwei Tage vor dem Event und 14 Tage danach
- Description den Namen herausnehmen

```{r}

# Removing unnecessary expressions

for (i in 1:10) {
   table[[i]]$Injured <- gsub("[n 1]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 2]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 3]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 4]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 5]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 6]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 7]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 8]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("[n 9]", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Injured <- gsub("+", "", table[[i]]$Injured, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 1]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 2]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 3]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 4]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 5]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 6]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 7]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 8]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("[n 9]", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Dead <- gsub("+", "", table[[i]]$Dead, fixed = TRUE)
   table[[i]]$Total <- gsub("+", "", table[[i]]$Total, fixed = TRUE)
}


# Storing Injured, Dead and Total as numerics

for (i in 1:10) {
  as.numeric(as.character(table[[i]]$Injured))
  as.numeric(as.character(table[[i]]$Dead))
  as.numeric(as.character(table[[i]]$Total))
}


#####################################
# Date formatting not working
#dates <- table[[1]]$Date
#betterDates <- as.Date(dates,
#format = "%m %d %Y")

#table[[1]]

#for (i in 1:10) {
  #parse_date_time2("table[[i]]$Date", orders = "mdy")
  #as_date(table[[i]]$Date, tz = NULL, format = NULL)
  #as_date(table[[i]]$Date, origin = lubridate::origin)
  #c(as_date(table[[i]]$Date), as.Date(table[[i]]$Date))
#  date <- as.Date(table[[i]]$Date, format = "%B %d, %Y")
#}

#table[[1]]
####################################################

# Joining all tables to one data frame

newtab <- table[[1]]

for (i in 1:10) {
  newtab <- newtab %>% full_join(table[[i]], by = c("Date", "Location", "Dead", "Injured", "Total", "Description"))
}

newtab

# Works for simple dates, need to think about how we handle timespans --> at the moment converting them gives NAs

str(newtab$Date)

for (i in 1:10) {
   newtab$Date <- gsub(" ", "-", newtab$Date, fixed = TRUE)
   newtab$Date <- gsub(",", "", newtab$Date, fixed = TRUE)
}

newtab


#Deleting the useless part of description --> possibly need to remove year as nobody googles the year when event is happening

newtab$Description <- sub(":.*$", "", newtab$Description)
newtab
```


```{r}
lct <- Sys.getlocale("LC_TIME"); Sys.setlocale("LC_TIME", "C")
newtab[["Date"]] <- as.Date(newtab$Date, format = "%B-%d-%Y")
newtab

newtab$Prior <- newtab$Date - 2
newtab$After <- newtab$Date + 14
newtab

newtab <- na.omit(newtab)


#colnames(newtab)
newtab <- newtab[, c("Date", "Prior", "After", "Location", "Dead", "Injured", "Total", "Description")] 
newtab

newtab$TrendPeriod <- paste(newtab$Prior, newtab$After)
newtab

```

Erwähnen, dass wir nur nach einem Begriff suchen
Search Terms verglichen bei Trends 
Alle Events, die über Tage gehen gedropped
Sophie: 6-10 subben
Hannah: 11-15 

```{r}

newtab$SearchTerm <- gsub("shootout", "shooting", newtab$Description, fixed = TRUE)
newtab

newtab <- newtab[, c("Date", "Prior", "After", "TrendPeriod", "SearchTerm", "Description", "Location", "Dead", "Injured", "Total")] 
newtab

number <- c("2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019")

as.character(number)

for (i in number){
   newtab$SearchTerm <- gsub(i , "", newtab$SearchTerm, fixed = TRUE)
}
newtab

newtab$SearchTerm <- gsub(" at Charlotte", "", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("January ", "", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub(", ", " ", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("shootings", "shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("attack", "shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Shooting of Jemel Roberson", "Jemel Roberson shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Fifth Third Center shooting", "Cincinatti shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Jacksonville Landing shooting", "Jacksonville shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Art All Night shooting", "Trenton shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Copper Canyon Apartment Homes shooting", "Highlands Ranch shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Rancho Tehama Reserve shooting", "Tehama shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Sutherland Springs church shooting", "Sutherland Springs shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Burnette Chapel shooting", "Antioch shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Clovis library shooting", "Clovis shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Little Rock nightclub shooting", "Little Rock shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Bronx-Lebanon Hospital shooting", "Bronx shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("San Francisco UPS shooting", "San Francisco shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Congressional baseball shooting", "Alexandria shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Eaton Township Weis Markets shooting", "Weis Markets shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Sandy Utah shooting", "Sandy shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Orlando factory shooting", "Orlando shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("North Park Elementary School shooting", "North Park shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Cincinnati nightclub shooting", "Cincinnati shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Schofield/Rothschild shooting", "Rothschild shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Fort Lauderdale airport shooting", "Fort Lauderdale shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Townville Elementary School shooting", "Townville shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Citronelle homicides", "Citronelle shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("shooting of Baton Rouge police officers", "Baton Rouge shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("St. Joseph courthouse shooting", "Courthouse shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("shooting of Dallas police officers", "Dallas shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Orlando nightclub shooting", "Orlando shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Wilkinsburg mass shooting", "Wilkinsburg shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Colorado Springs Planned Parenthood shooting", "Planned Parenthood shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Shooting of protesters at a Black Lives Matter protest", "Minneapolis shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Umpqua Community College shooting", "Roseburg shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Murders of Alison Parker and Adam Ward", "Roanoke shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Charleston church shooting", "Charleston shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Rosemary Anderson High School shooting", "Portland shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Marysville Pilchuck High School shooting", "Marysville shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Isla Vista killings", "Isla Vista shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Ross Township Municipal Building shooting", "Ross Township shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("South Valley homicides", "South Valley shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Sandy Hook Elementary School ()", "Sandy Hook shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Clackamas Town Center shooting", "Clackamas shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Azana Spa shooting", "Brookfield shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Wisconsin Sikh temple shooting", "Oak Creek shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Aurora Colorado movie theater shooting", "Aurora shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Seattle cafe shooting spree", "Seattle shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Chardon High School shooting", "Chardon School shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Southern California Edison shooting", "Edison shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Carson City IHOP shooting", "Carson shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Copley Township shooting", "Copley shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Grand Rapids mass murder", "Grand Rapids shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Safeway Shooting in Casas Adobes Arizona ()", "Tucson shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Hartford Beer Distributors shooting", "Manchester shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("University of Alabama in Huntsville shooting", "University of Alabama shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("ABB plant shooting", "St Louis shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Fort Hood Military Base shooting", "Fort Hood shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Shooting of Pittsburgh Police Officers", "Pittsburgh shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("New York immigration center shooting", "Binghampton shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Carthage nursing home shooting", "Carthage shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Geneva County massacre", "Geneva shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Covina massacre", "Covina shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Skagit County Shooting Spree ()", "Skagit Shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Northern Illinois University shooting", "Illinois shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Kirkwood City Council shooting", "Kirkwood shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Lane Bryant shooting", "Tinley Park shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Youth with a Mission and New Life Church shooting", "Colorado shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Westroads Mall shooting ()", "Omaha shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Crandon Wisconsin duplex shooting ()", "Crandon shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("West Nickel Mines School shooting", "Bart shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Seattle Jewish Federation shooting", "Seattle shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Capitol Hill massacre", "Seattle shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Goleta postal facility shooting", "Goleta shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Tacoma Mall shooting", "Tacoma shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Red Lake Indian Reservation shooting", "Red Lake shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Columbus nightclub shooting", "Columbus shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Hunting Trip ()", "Meteor shooting", newtab$SearchTerm, fixed = TRUE)
newtab$SearchTerm <- gsub("Wesson family murders", "Fresno shooting", newtab$SearchTerm, fixed = TRUE)

newtab <- newtab[format(newtab$Date,'%Y') != "2003", ]
newtab <- newtab[format(newtab$Date,'%Y') != "2002", ]
newtab <- newtab[format(newtab$Date,'%Y') != "2001", ]
newtab <- newtab[format(newtab$Date,'%Y') != "2000", ]

newtab


```
Delisle tripple murder droppen -->> nicht genug daten
Bart shooting evtl. rausnehmen --> sieht aus als hätte es sehr kleine Fallzahlen und einen seltsamen Verlauf
Meteor shooting sieht komish aus --> evtl droppen wegen kleiner Fallzahl

```{r}
# Exporting data frame to excel in order to add further variables

#Pfad Hannah
#write_xlsx(newtab,"C:\\Users\\hre\\Documents\\Uni_Mannheim\\FSS_2020\\Research_Methods_Fundamentals_of_Computing_and_Data_Display\\Paper\\Term-Paper-Fundamentals\\wikishootings.xlsx")

#Pfad Sophie
#write_xlsx(newtab,"/Users/sophiehensgen/Term-Paper-Fundamentals/Fundamentals---Term-Paper-/WikiShootingscomplete.xlsx")
```

```{r}
# Inporting excel Data 

wikishooting <- read_excel("WikiShootingscomplete.xlsx")
wikishooting

```

```{r}
# correcting Data types

wikishooting[["Date"]] <- as.Date(wikishooting$Date, format = "%Y-%m-%d")
wikishooting[["Prior"]] <- as.Date(wikishooting$Date, format = "%Y-%m-%d")
wikishooting[["After"]] <- as.Date(wikishooting$Date, format = "%Y-%m-%d")

wikishooting

# dropping NAs

wikishooting$Ethnicity[wikishooting$Ethnicity == "NA"] <- NA
wikishooting <- na.omit(wikishooting)

# correcting Data types

wikishooting$Ethnicity <- as.numeric(wikishooting$Ethnicity)

wikishooting$TrendPeriod <- gsub("2008-12-22 2009-01-07", "2008-12-22 2009-01-21", wikishooting$TrendPeriod, fixed = TRUE)
wikishooting

```

############################################################################################################################################
############################################################################################################################################
############################################################################################################################################

## GTrend Data 

Gtrends 
--> scraping von mehreren Namen auf einmal --> Text ob es mit einem funktioniert

```{r}
shootings <- gtrends(c("Milwaukee shooting", "Grantsville shooting", "El Paso shooting"), geo = "US", time = "2012-01-01 2020-05-07", low_search_volume = T)
plot(shootings)
shootings
```

Versuch eines Loop der einzelne outcomes speichert
```{r}

listshooting <- list()
for (i in 1:nrow(wikishooting)){
    x <- as.vector(wikishooting$SearchTerm[i])
    y <- as.vector(wikishooting$TrendPeriod[i])
    shooting <- gtrends(keyword = x, geo = "US", time = y, low_search_volume = T)
    iteration <- (1 + length(listshooting))
    listshooting[[iteration]] <- shooting
 }



# Versuch das beide Variablen die selbe reihe ansprechen

listshooting <- list()
for (i in wikishooting$SearchTerm){
    for (k in wikishooting$TrendPeriod){
      if (i == k) {                       # platzhalter
    shooting <- gtrends(keyword = i, geo = "US", time = k, low_search_volume = T)
    print(shooting)
    listshooting <- append(listshooting, shooting)
    }
    }
}

# Beispiel wie man die einzelnen Tabellen verbindet
massshooting <- rbind(listshooting[[1]], listshooting[[8]], listshooting[[15]], listshooting[[22]])
massshooting

```

First, we transform the `data.frame` into a `tibble`.

```{r}
shootings_trend <- as_tibble(massshooting$interest_over_time)
glimpse(shootings_trend)
```

## Fragen: 
   - Loop bezüglich der Gtrends, erste Versuche oben.
   - Wie hinzufügen in eine Tabelle und zu der Wikishootingstabelle

############################################################################################################################################
############################################################################################################################################
############################################################################################################################################

## Data Analysis


```{r}
# Regression 

lm(x ~ Dead + Injured + Ethnicity + Area + GunLaws, data = wikishooting, )
```

## Fragen: 
   - Wie soll das y aussehen.
   - Wie soll die Abnahme dargestellt/codiert werden?
   - Welches Model ist hierfür am besten geeignet?
   - Brauchen wir mehrere Modelle oder reicht eines?
   - Kontrollvariablen - brauchen wir noch Weitere?






